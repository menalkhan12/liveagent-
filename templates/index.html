<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#0f172a">
    <title>IST Voice Assistant | Institute of Space Technology</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-elevated: #334155;
            --accent: #38bdf8; --success: #34d399; --danger: #f87171;
            --text: #f1f5f9; --text-muted: #94a3b8; --border: rgba(255,255,255,0.08);
        }
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
            background: var(--bg-dark);
            background-image: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(56,189,248,0.15), transparent),
                              radial-gradient(ellipse 60% 40% at 100% 100%, rgba(34,211,238,0.08), transparent);
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            padding: max(24px, env(safe-area-inset-top)) max(24px, env(safe-area-inset-right))
                     max(24px, env(safe-area-inset-bottom)) max(24px, env(safe-area-inset-left));
            color: var(--text);
        }
        .container {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 24px; padding: 40px; max-width: 560px; width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        @media (max-width: 480px) { .container { padding: 24px 20px; } h1 { font-size: 20px !important; } }
        .header { text-align: center; margin-bottom: 32px; }
        .logo {
            display: inline-flex; align-items: center; justify-content: center;
            width: 64px; height: 64px;
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            border-radius: 16px; font-size: 28px; margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(56,189,248,0.3);
        }
        h1 { font-size: 24px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.02em; }
        .subtitle { font-size: 14px; color: var(--text-muted); font-weight: 500; }
        .status {
            padding: 16px 20px; background: var(--bg-elevated);
            border-radius: 14px; border: 1px solid var(--border);
            color: var(--success); font-size: 14px; font-weight: 500;
            margin-bottom: 24px; display: flex; align-items: center; gap: 10px;
        }
        .status.recording { color: var(--accent); border-color: rgba(56,189,248,0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .status.recording .status-dot { animation: pulse-dot 1.2s ease-in-out infinite; }
        @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.2)} }
        .button-group { display: flex; gap: 12px; margin-bottom: 16px; }
        button {
            flex: 1; padding: 18px 24px; min-height: 56px;
            font-size: 16px; font-weight: 600; font-family: inherit;
            border: none; border-radius: 14px; cursor: pointer;
            transition: all 0.2s ease; -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; -webkit-touch-callout: none;
            user-select: none; -webkit-user-select: none;
        }
        #startBtn { background: linear-gradient(135deg, var(--success), #10b981); color: white; box-shadow: 0 4px 14px rgba(52,211,153,0.4); }
        #startBtn:disabled { background: var(--bg-elevated); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        #endBtn { background: linear-gradient(135deg, var(--danger), #ef4444); color: white; box-shadow: 0 4px 14px rgba(248,113,113,0.3); }
        #endBtn:disabled { background: var(--bg-elevated); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        #recordBtn {
            display: none; width: 100%; padding: 20px 24px; min-height: 60px;
            font-size: 17px; font-weight: 700; font-family: inherit;
            border: none; border-radius: 14px; cursor: pointer;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            color: white; box-shadow: 0 4px 14px rgba(56,189,248,0.4);
            transition: all 0.15s ease;
        }
        #recordBtn.active {
            background: linear-gradient(135deg, var(--danger), #ef4444);
            box-shadow: 0 4px 20px rgba(248,113,113,0.6);
            transform: scale(1.02);
        }
        .transcript {
            background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px;
            min-height: 200px; max-height: 340px;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .message { margin: 10px 0; padding: 14px 16px; border-radius: 12px; font-size: 14px; line-height: 1.6; }
        .user-msg { background: rgba(56,189,248,0.12); border: 1px solid rgba(56,189,248,0.2); margin-left: 20px; }
        .agent-msg { background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.15); margin-right: 20px; }
        .loading { color: var(--text-muted); font-size: 13px; font-style: italic; }
        .spinner {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid var(--bg-elevated); border-top-color: var(--accent);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin-right: 8px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mode-hint { text-align: center; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; min-height: 18px; }
        .info { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; margin-top: 20px; font-size: 12px; color: var(--text-muted); }
        .info span { display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo">ğŸ™ï¸</div>
        <h1>Institute of Space Technology</h1>
        <p class="subtitle">Voice Assistant â€” Ask anything about IST</p>
    </div>
    <div class="status" id="statusDiv"><span class="status-dot"></span><strong>Ready</strong> â€” Click Start to begin</div>
    <div class="button-group">
        <button id="startBtn" onclick="startCall()">â–¶ Start Call</button>
        <button id="endBtn" onclick="endCall()" disabled>â–  End Call</button>
    </div>
    <button id="recordBtn" id="recordBtn">ğŸ¤ Hold to Speak</button>
    <div class="mode-hint" id="modeHint"></div>
    <div class="transcript" id="transcript">
        <p class="loading">Click "Start Call" to speak with the IST voice assistant.</p>
        <div id="transcriptStatus"></div>
    </div>
    <div class="info">
        <span>ğŸ§  Knowledge Base</span>
        <span>ğŸ¯ Voice Detection</span>
        <span>ğŸ”Š Natural Voice</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.29/dist/bundle.min.js"></script>
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sessionId = null, isCallActive = false;
let stream = null, vadInstance = null;
let currentAudio = null;
let requestInFlight = false, greetingPlaying = false;
let useManualMode = false;
let mediaRecorder = null, recChunks = [], isRecording = false;
let audioCtx = null;

// â”€â”€ Device detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isAndroid = /Android/.test(navigator.userAgent);

// â”€â”€ WAV encoder (for VAD Float32 PCM output) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function encodeWAV(samples, sr) {
    const nc = 1, bps = 16, br = sr * nc * 2;
    const ds = samples.length * 2;
    const buf = new ArrayBuffer(44 + ds);
    const v = new DataView(buf);
    const ws = (o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
    ws(0,'RIFF'); v.setUint32(4,36+ds,true); ws(8,'WAVE'); ws(12,'fmt ');
    v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,nc,true);
    v.setUint32(24,sr,true); v.setUint32(28,br,true);
    v.setUint16(32,nc*2,true); v.setUint16(34,bps,true);
    ws(36,'data'); v.setUint32(40,ds,true);
    for (let i = 0; i < samples.length; i++) {
        const s = Math.max(-1, Math.min(1, samples[i]));
        v.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
    return buf;
}

// â”€â”€ Convert any blob â†’ WAV via AudioContext (cross-browser) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toWav(blob) {
    try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        const ab = await blob.arrayBuffer();
        const decoded = await audioCtx.decodeAudioData(ab);
        let ch = decoded.getChannelData(0);
        if (decoded.sampleRate !== 16000) {
            const ratio = decoded.sampleRate / 16000;
            const out = new Float32Array(Math.round(ch.length / ratio));
            for (let i = 0; i < out.length; i++) out[i] = ch[Math.round(i * ratio)];
            ch = out;
        }
        return new Blob([encodeWAV(ch, 16000)], { type: 'audio/wav' });
    } catch (e) {
        console.warn('toWav failed, sending original:', e);
        return blob;
    }
}

// â”€â”€ Best MIME type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bestMime() {
    for (const t of ['audio/mp4', 'audio/webm;codecs=opus', 'audio/webm', 'audio/ogg', '']) {
        if (!t || (window.MediaRecorder && MediaRecorder.isTypeSupported(t))) return t;
    }
    return '';
}

// â”€â”€ iOS audio unlock â€” must call inside a user gesture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function unlockAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
    if (audioCtx.state === 'suspended') {
        try { await audioCtx.resume(); } catch(_) {}
    }
    // Play a silent buffer to fully unlock iOS audio
    try {
        const buf = audioCtx.createBuffer(1, 1, 16000);
        const src = audioCtx.createBufferSource();
        src.buffer = buf;
        src.connect(audioCtx.destination);
        src.start(0);
    } catch(_) {}
}

// â”€â”€ Play audio â€” with iOS fallback via AudioContext â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playAudio(url, onDone) {
    // Always use HTML Audio element (works on both platforms)
    // But keep a reference so we can interrupt
    if (currentAudio) {
        try { currentAudio.pause(); } catch(_) {}
        currentAudio = null;
    }
    const a = new Audio();
    a.setAttribute('playsinline', 'true');
    a.setAttribute('webkit-playsinline', 'true');
    a.preload = 'auto';
    a.src = url;
    currentAudio = a;

    a.onended = () => { currentAudio = null; if (onDone) onDone(); };
    a.onerror = () => { currentAudio = null; if (onDone) onDone(); };

    const p = a.play();
    if (p && p.catch) {
        p.catch(err => {
            console.warn('Audio play blocked:', err);
            // iOS sometimes needs a tiny delay after user gesture chain breaks
            setTimeout(() => {
                const a2 = new Audio(url);
                a2.setAttribute('playsinline', 'true');
                a2.setAttribute('webkit-playsinline', 'true');
                currentAudio = a2;
                a2.onended = () => { currentAudio = null; if (onDone) onDone(); };
                a2.onerror = () => { currentAudio = null; if (onDone) onDone(); };
                a2.play().catch(() => {
                    // Give up on audio, just call onDone so UI continues
                    currentAudio = null;
                    if (onDone) onDone();
                });
            }, 100);
        });
    }
}

// â”€â”€ Status helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(html, rec = false) {
    const el = document.getElementById('statusDiv');
    el.innerHTML = `<span class="status-dot"></span>${html}`;
    el.className = 'status' + (rec ? ' recording' : '');
}
function addMsg(text, cls) {
    const d = document.createElement('div');
    d.className = `message ${cls}`;
    d.textContent = text;
    document.getElementById('transcript').appendChild(d);
    const t = document.getElementById('transcript');
    t.scrollTop = t.scrollHeight;
}
function setProcessing(msg) {
    const s = document.getElementById('transcriptStatus');
    if (s) s.innerHTML = `<p class="loading"><span class="spinner"></span>${msg}</p>`;
}
function clearProcessing(msg = '') {
    const s = document.getElementById('transcriptStatus');
    if (s) s.innerHTML = msg ? `<p class="loading">${msg}</p>` : '';
}

// â”€â”€ Manual record (iOS / VAD fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showManualMode() {
    useManualMode = true;
    const btn = document.getElementById('recordBtn');
    btn.style.display = 'block';
    document.getElementById('modeHint').textContent = isIOS
        ? 'ğŸ“± iPhone mode â€” Hold the button and speak, release when done'
        : 'ğŸ“± Hold the button to speak, release when done';

    // Touch events
    btn.addEventListener('touchstart', e => {
        e.preventDefault();
        if (!isCallActive || requestInFlight || greetingPlaying || isRecording) return;
        startRec();
    }, { passive: false });

    const stopOnTouch = e => {
        e.preventDefault();
        if (isRecording) stopRec();
    };
    btn.addEventListener('touchend', stopOnTouch, { passive: false });
    btn.addEventListener('touchcancel', stopOnTouch, { passive: false });

    // Mouse events (desktop fallback)
    btn.addEventListener('mousedown', () => {
        if (!isCallActive || requestInFlight || greetingPlaying || isRecording) return;
        startRec();
    });
    document.addEventListener('mouseup', () => { if (isRecording) stopRec(); });
}

function startRec() {
    if (!stream) return;
    const mime = bestMime();
    try {
        mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
        recChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recChunks.push(e.data); };
        mediaRecorder.start(100);
        isRecording = true;
        const btn = document.getElementById('recordBtn');
        btn.textContent = 'ğŸ”´ Recordingâ€¦ Release to send';
        btn.classList.add('active');
        setStatus('<strong>Recording</strong> â€” Release button when done', true);
    } catch(e) {
        console.error('MediaRecorder error:', e);
        setStatus('âš ï¸ Could not record. Try again.');
    }
}

async function stopRec() {
    if (!isRecording || !mediaRecorder) return;
    isRecording = false;
    const btn = document.getElementById('recordBtn');
    btn.textContent = 'ğŸ¤ Hold to Speak';
    btn.classList.remove('active');
    setStatus('<strong>Processingâ€¦</strong>', true);

    await new Promise(resolve => {
        mediaRecorder.onstop = async () => {
            const mime = bestMime();
            const raw = new Blob(recChunks, { type: mime || 'audio/webm' });
            if (raw.size < 500) {
                setStatus('<strong>Ready</strong> â€” Hold button and speak clearly', true);
                clearProcessing('Hold button and speak clearlyâ€¦');
                resolve(); return;
            }
            const wav = await toWav(raw);
            await sendAudio(wav);
            resolve();
        };
        mediaRecorder.stop();
    });
}

// â”€â”€ Start Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCall() {
    // MUST be inside user gesture â€” unlock audio here
    await unlockAudio();

    document.getElementById('startBtn').disabled = true;
    setStatus('<strong>Startingâ€¦</strong> â€” Requesting microphone', true);
    document.getElementById('transcript').innerHTML =
        '<p class="loading"><span class="spinner"></span>Starting callâ€¦</p><div id="transcriptStatus"></div>';

    // Mic permission
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true, channelCount: 1 }
        });
    } catch(e) {
        let msg = 'âš ï¸ Microphone access denied.';
        if (e.name === 'NotFoundError') msg = 'âš ï¸ No microphone found.';
        else if (e.name === 'NotAllowedError') {
            msg = isIOS
                ? 'âš ï¸ Allow mic: Settings â†’ Safari â†’ Microphone â†’ Allow'
                : 'âš ï¸ Please allow microphone access and refresh.';
        }
        document.getElementById('transcript').innerHTML = `<p style="color:var(--danger);">${msg}</p>`;
        document.getElementById('startBtn').disabled = false;
        setStatus('<strong>Ready</strong> â€” Click Start to begin');
        return;
    }

    // Start server session
    let data;
    try {
        const r = await fetch('/api/start_call', { method: 'POST' });
        data = await r.json();
    } catch(e) {
        document.getElementById('transcript').innerHTML = `<p style="color:var(--danger);">âš ï¸ Cannot connect to server. Check your connection.</p>`;
        document.getElementById('startBtn').disabled = false;
        stream.getTracks().forEach(t => t.stop());
        return;
    }

    sessionId = data.session_id;
    isCallActive = true;
    document.getElementById('endBtn').disabled = false;

    // Try VAD â€” skip on iOS (ONNX/VAD doesn't work reliably on iOS Safari)
    let vadOk = false;
    if (!isIOS && typeof vad !== 'undefined') {
        try {
            vadInstance = await vad.MicVAD.new({
                getStream: async () => stream,
                onSpeechStart: () => {
                    // Interrupt agent audio if user starts speaking
                    if (currentAudio && !greetingPlaying) {
                        try { currentAudio.pause(); } catch(_){}
                        currentAudio = null;
                        requestInFlight = false;
                    }
                },
                onSpeechEnd: async (audio) => {
                    if (!isCallActive || requestInFlight || greetingPlaying) return;
                    if (audio.length < 8000) return;
                    const blob = new Blob([encodeWAV(audio, 16000)], { type: 'audio/wav' });
                    await sendAudio(blob);
                },
                positiveSpeechThreshold: 0.90,
                negativeSpeechThreshold: 0.70,
                minSpeechFrames: 8,
                redemptionFrames: 10,
                onnxWASMBasePath: 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/',
                baseAssetPath: 'https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.29/dist/'
            });
            vadOk = true;
        } catch(e) {
            console.warn('VAD init failed, using manual mode:', e);
        }
    }

    if (!vadOk) showManualMode();

    // Show greeting
    greetingPlaying = true;
    setStatus('<strong>Connected</strong> â€” Playing greetingâ€¦', true);
    document.getElementById('transcript').innerHTML =
        '<div class="message agent-msg">ğŸ¤– Hello, this is Institute of Space Technology. How can I help you today?</div>' +
        '<div id="transcriptStatus"><p class="loading" style="margin-top:10px;">Speak your question clearly.</p></div>';

    const afterGreeting = () => {
        greetingPlaying = false;
        if (vadOk && vadInstance) {
            vadInstance.start();
            setStatus('<strong>Listening</strong> â€” Speak anytime', true);
        } else {
            setStatus('<strong>Ready</strong> â€” Hold the button and speak', true);
            clearProcessing('Hold the button and speak your questionâ€¦');
        }
    };

    if (data.greeting_audio_url) {
        if (vadOk && vadInstance) vadInstance.pause();
        playAudio(data.greeting_audio_url, afterGreeting);
    } else {
        afterGreeting();
    }
}

// â”€â”€ Send audio to server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendAudio(blob) {
    if (!sessionId || !isCallActive) return;
    requestInFlight = true;
    if (vadInstance) { try { vadInstance.pause(); } catch(_){} }

    setProcessing('Processing your questionâ€¦');
    setStatus('<strong>Processingâ€¦</strong>', true);

    const ctrl = new AbortController();
    const tid = setTimeout(() => ctrl.abort(), 55000);
    const longTid = setTimeout(() => {
        if (requestInFlight) setProcessing('Taking a moment, please waitâ€¦');
    }, 12000);

    try {
        const fd = new FormData();
        fd.append('session_id', sessionId);
        fd.append('audio', blob, 'audio.wav');

        const res = await fetch('/api/query', { method: 'POST', body: fd, signal: ctrl.signal });
        clearTimeout(tid); clearTimeout(longTid);
        const data = await res.json();

        if (!res.ok || data.error) {
            const msg = (data && data.error) || 'Something went wrong. Please try again.';
            if (data && data.user_text) addMsg('ğŸ¤ ' + data.user_text, 'user-msg');
            addMsg('ğŸ¤– ' + msg, 'agent-msg');
            clearProcessing('Speak your question againâ€¦');
            done();
            return;
        }

        if (data.user_text) addMsg('ğŸ¤ ' + data.user_text, 'user-msg');

        if (data.audio_url && data.response) {
            clearProcessing();
            addMsg('ğŸ¤– ' + data.response, 'agent-msg');
            playAudio(data.audio_url, () => {
                clearProcessing('Speak your next questionâ€¦');
                done();
            });
        } else if (data.response) {
            clearProcessing();
            addMsg('ğŸ¤– ' + data.response, 'agent-msg');
            clearProcessing('Speak your next questionâ€¦');
            done();
        } else {
            clearProcessing('Speak your next questionâ€¦');
            done();
        }
    } catch(e) {
        clearTimeout(tid); clearTimeout(longTid);
        const msg = e.name === 'AbortError' ? 'Request timed out. Please try again.' : e.message;
        addMsg('âš ï¸ ' + msg, 'message');
        clearProcessing('Speak your question againâ€¦');
        done();
    }
}

function done() {
    requestInFlight = false;
    if (isCallActive) {
        if (vadInstance) { try { vadInstance.start(); } catch(_){} }
        setStatus(useManualMode ? '<strong>Ready</strong> â€” Hold button to speak' : '<strong>Listening</strong> â€” Speak anytime', true);
    }
}

// â”€â”€ End Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function endCall() {
    isCallActive = false;
    if (currentAudio) { try { currentAudio.pause(); } catch(_){} currentAudio = null; }
    if (isRecording && mediaRecorder) { try { mediaRecorder.stop(); } catch(_){} isRecording = false; }
    if (vadInstance) { try { vadInstance.pause(); vadInstance.destroy(); } catch(_){} vadInstance = null; }
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

    if (sessionId) {
        try {
            await fetch('/api/end_call', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            });
        } catch(_){}
    }

    requestInFlight = false;
    document.getElementById('endBtn').disabled = true;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('recordBtn').style.display = 'none';
    document.getElementById('modeHint').textContent = '';
    useManualMode = false;
    setStatus('<strong>Ended</strong> â€” Click Start to begin again');
    addMsg('âœ“ Call ended. Click Start to begin a new call.', 'agent-msg');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
    document.getElementById('startBtn').focus();
    if (isIOS) document.getElementById('modeHint').textContent = 'ğŸ“± iPhone detected â€” tap Start, then hold button to speak';
    // Pre-create AudioContext on first touch (iOS requirement)
    const unlock = () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    };
    document.addEventListener('touchstart', unlock, { once: true, passive: true });
    document.addEventListener('click', unlock, { once: true });
});
</script>
</body>
</html>